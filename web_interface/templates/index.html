<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sherlock - Username Search</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>üîç Sherlock Username Search</h1>
            <p class="subtitle">Hunt down social media accounts by username across 400+ social networks</p>
        </header>

        <div class="search-section">
            <div class="search-mode-toggle">
                <button class="mode-btn active" data-mode="username">Username Search</button>
                <button class="mode-btn" data-mode="name">Username Generator</button>
                <button class="mode-btn" data-mode="fullname">Full Name OSINT</button>
            </div>

            <div id="username-search" class="search-mode-section">
                <div class="form-group">
                    <label for="usernames">Username(s) to Search:</label>
                    <input type="text" id="usernames" placeholder="Enter username(s) separated by spaces" autocomplete="off">
                    <small>Example: john_doe jane_smith</small>
                </div>
            </div>

            <div id="name-search" class="search-mode-section hidden">
                <div class="form-group">
                    <label for="fullname">Full Name to Search:</label>
                    <input type="text" id="fullname" placeholder="Enter full name (e.g., John Smith)" autocomplete="off">
                    <small>We'll generate common username variations automatically</small>
                </div>
                <div class="info-box">
                    <strong>How it works:</strong> We'll generate variations like:<br>
                    ‚Ä¢ johnsmith, john_smith, john.smith<br>
                    ‚Ä¢ jsmith, smithjohn<br>
                    ‚Ä¢ And more patterns based on the name
                </div>
            </div>

            <div id="fullname-search" class="search-mode-section hidden">
                <div class="form-group">
                    <label for="osintname">Full Name for OSINT Search:</label>
                    <input type="text" id="osintname" placeholder="Enter full name (e.g., John Smith)" autocomplete="off">
                    <small>Get Google dorks, social media links, and people search links</small>
                </div>
                <div class="info-box">
                    <strong>This will generate:</strong><br>
                    ‚Ä¢ üîç Google Dorks (advanced search queries)<br>
                    ‚Ä¢ üë§ Direct social media search links (Facebook, LinkedIn, Twitter, Instagram, etc.)<br>
                    ‚Ä¢ üìã People search engine links (TruePeopleSearch, WhitePages, etc.)<br>
                    <em>One-click access to all search tools in new tabs</em>
                </div>
            </div>

            <div class="options-section">
                <h3>Search Options</h3>

                <div class="options-grid">
                    <div class="option">
                        <label>
                            <input type="checkbox" id="csv"> Export as CSV
                        </label>
                    </div>

                    <div class="option">
                        <label>
                            <input type="checkbox" id="xlsx"> Export as Excel (XLSX)
                        </label>
                    </div>

                    <div class="option">
                        <label>
                            <input type="checkbox" id="nsfw"> Include NSFW sites
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="timeout">Timeout (seconds):</label>
                    <input type="number" id="timeout" value="60" min="10" max="300">
                </div>

                <div class="form-group">
                    <label for="sites">Specific Sites (optional):</label>
                    <input type="text" id="sites" placeholder="e.g., GitHub, Twitter, Instagram">
                    <small>Leave empty to search all sites, or enter site names separated by commas</small>
                </div>

                <div class="form-group">
                    <label for="proxy">Proxy (optional):</label>
                    <input type="text" id="proxy" placeholder="e.g., socks5://127.0.0.1:1080">
                </div>
            </div>

            <button id="searchBtn" class="btn-primary">Start Search</button>
        </div>

        <div id="status" class="status-section hidden">
            <h3>Search Status</h3>
            <div class="status-content">
                <div class="spinner"></div>
                <p id="statusText">Initializing search...</p>
            </div>
        </div>

        <div id="results" class="results-section hidden">
            <h3>Results</h3>

            <div class="results-summary">
                <div class="summary-card found">
                    <div class="count" id="foundCount">0</div>
                    <div class="label">Accounts Found</div>
                </div>
                <div class="summary-card not-found">
                    <div class="count" id="notFoundCount">0</div>
                    <div class="label">Not Found</div>
                </div>
                <div class="summary-card checked">
                    <div class="count" id="checkedCount">0</div>
                    <div class="label">Sites Checked</div>
                </div>
            </div>

            <div id="currentlyChecking" class="checking-section hidden">
                <h4>Currently Checking:</h4>
                <div id="checkingList" class="checking-list"></div>
            </div>

            <div class="export-section" id="exportSection">
                <h4>Export Results</h4>
                <div id="filesList"></div>
            </div>

            <div class="tabs">
                <button class="tab-btn active" data-tab="found">Found Accounts</button>
                <button class="tab-btn" data-tab="notfound">Not Found</button>
                <button class="tab-btn" data-tab="raw">Raw Output</button>
            </div>

            <div class="tab-content active" id="found-tab">
                <div id="foundResults" class="results-list"></div>
            </div>

            <div class="tab-content" id="notfound-tab">
                <div id="notFoundResults" class="results-list"></div>
            </div>

            <div class="tab-content" id="raw-tab">
                <pre id="rawOutput"></pre>
            </div>
        </div>
    </div>

    <script>
        let currentSearchId = null;
        let statusCheckInterval = null;
        let currentMode = 'username';

        document.getElementById('searchBtn').addEventListener('click', startSearch);

        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const tabName = this.dataset.tab;
                switchTab(tabName);
            });
        });

        // Mode toggle
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const mode = this.dataset.mode;
                switchMode(mode);
            });
        });

        function switchMode(mode) {
            currentMode = mode;

            // Update buttons
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-mode="${mode}"]`).classList.add('active');

            // Show/hide appropriate search section
            document.getElementById('username-search').classList.add('hidden');
            document.getElementById('name-search').classList.add('hidden');
            document.getElementById('fullname-search').classList.add('hidden');

            if (mode === 'username') {
                document.getElementById('username-search').classList.remove('hidden');
            } else if (mode === 'name') {
                document.getElementById('name-search').classList.remove('hidden');
            } else if (mode === 'fullname') {
                document.getElementById('fullname-search').classList.remove('hidden');
            }
        }

        async function startSearch() {
            let searchData = {
                mode: currentMode,
                options: {
                    timeout: parseInt(document.getElementById('timeout').value),
                    csv: document.getElementById('csv').checked,
                    xlsx: document.getElementById('xlsx').checked,
                    nsfw: document.getElementById('nsfw').checked,
                }
            };

            // Get input based on mode
            if (currentMode === 'username') {
                const usernames = document.getElementById('usernames').value.trim();
                if (!usernames) {
                    alert('Please enter at least one username');
                    return;
                }
                searchData.usernames = usernames;
            } else {
                const fullname = document.getElementById('fullname').value.trim();
                if (!fullname) {
                    alert('Please enter a full name');
                    return;
                }
                searchData.fullname = fullname;
            }

            const sitesInput = document.getElementById('sites').value.trim();
            if (sitesInput) {
                searchData.options.sites = sitesInput.split(',').map(s => s.trim());
            }

            const proxyInput = document.getElementById('proxy').value.trim();
            if (proxyInput) {
                searchData.options.proxy = proxyInput;
            }

            // Show status section
            document.getElementById('status').classList.remove('hidden');
            document.getElementById('results').classList.add('hidden');
            document.getElementById('statusText').textContent = currentMode === 'name' ? 'Generating username variations and starting search...' : 'Starting search...';

            try {
                const response = await fetch('/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(searchData)
                });

                const data = await response.json();

                if (response.ok) {
                    currentSearchId = data.search_id;
                    document.getElementById('statusText').textContent = `Searching for: ${data.usernames.join(', ')}...`;

                    // Start polling for status
                    statusCheckInterval = setInterval(checkStatus, 2000);
                } else {
                    document.getElementById('statusText').textContent = `Error: ${data.error}`;
                }
            } catch (error) {
                document.getElementById('statusText').textContent = `Error: ${error.message}`;
            }
        }

        async function checkStatus() {
            if (!currentSearchId) return;

            try {
                const response = await fetch(`/status/${currentSearchId}`);
                const data = await response.json();

                if (data.status === 'completed') {
                    clearInterval(statusCheckInterval);
                    document.getElementById('status').classList.add('hidden');
                    displayResults(data, true);
                    loadExportFiles();
                } else if (data.status === 'error') {
                    clearInterval(statusCheckInterval);
                    document.getElementById('statusText').textContent = `Error: ${data.error}`;
                } else if (data.status === 'running' && data.results) {
                    // Show live results while search is running
                    document.getElementById('status').classList.remove('hidden');
                    document.getElementById('results').classList.remove('hidden');
                    displayResults(data, false);
                    const foundCount = data.results.found.length;
                    const totalChecked = data.results.total_checked;
                    document.getElementById('statusText').textContent = `Search in progress... (${foundCount} found, ${totalChecked} sites checked)`;
                } else {
                    document.getElementById('statusText').textContent = 'Search in progress...';
                }
            } catch (error) {
                console.error('Error checking status:', error);
            }
        }

        function displayResults(data, isComplete) {
            document.getElementById('results').classList.remove('hidden');

            const results = data.results;

            // Update counts
            const foundText = isComplete ? results.found.length : `${results.found.length}+`;
            const notFoundText = isComplete ? results.not_found.length : `${results.not_found.length}+`;
            const checkedText = isComplete ? results.total_checked : `${results.total_checked}+`;
            document.getElementById('foundCount').textContent = foundText;
            document.getElementById('notFoundCount').textContent = notFoundText;
            document.getElementById('checkedCount').textContent = checkedText;

            // Display currently checking sites
            if (!isComplete && results.checking && results.checking.length > 0) {
                document.getElementById('currentlyChecking').classList.remove('hidden');
                const lastChecking = results.checking.slice(-10); // Show last 10
                document.getElementById('checkingList').innerHTML = lastChecking.map(site => `
                    <div class="checking-item">‚è≥ ${site}</div>
                `).join('');
            } else if (isComplete) {
                document.getElementById('currentlyChecking').classList.add('hidden');
            }

            // Display found accounts
            const foundDiv = document.getElementById('foundResults');
            if (results.found.length > 0) {
                foundDiv.innerHTML = results.found.map(item => `
                    <div class="result-item">
                        <div class="site-name">${item.site}</div>
                        <a href="${item.url}" target="_blank" class="site-url">${item.url}</a>
                    </div>
                `).join('');
            } else {
                foundDiv.innerHTML = '<p class="no-results">No accounts found</p>';
            }

            // Display not found sites
            const notFoundDiv = document.getElementById('notFoundResults');
            if (results.not_found.length > 0) {
                notFoundDiv.innerHTML = results.not_found.map(site => `
                    <div class="result-item-simple">${site}</div>
                `).join('');
            } else {
                notFoundDiv.innerHTML = '<p class="no-results">All sites checked returned results</p>';
            }

            // Display raw output
            document.getElementById('rawOutput').textContent = data.raw_output;
        }

        async function loadExportFiles() {
            if (!currentSearchId) return;

            try {
                const response = await fetch(`/list_files/${currentSearchId}`);
                const data = await response.json();

                if (data.files && data.files.length > 0) {
                    const filesList = document.getElementById('filesList');
                    filesList.innerHTML = data.files.map(file => `
                        <a href="/download/${currentSearchId}/${file}" class="download-link" download>
                            üìÑ ${file}
                        </a>
                    `).join('');
                    document.getElementById('exportSection').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error loading files:', error);
            }
        }

        function switchTab(tabName) {
            // Update buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            // Update content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }
    </script>
</body>
</html>
